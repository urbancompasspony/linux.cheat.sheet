#!/bin/bash

# Setup Waydroid com Distrobox no Ubuntu Server + Wayland

echo "ü§ñ Configurando Waydroid com Distrobox..."

# 1. PREPARAR O HOST (Ubuntu Server)
echo "üìã Verificando m√≥dulos do kernel..."

# Verificar se os m√≥dulos necess√°rios est√£o dispon√≠veis
if ! lsmod | grep -q binder; then
    echo "‚ö†Ô∏è  M√≥dulo binder n√£o encontrado. Tentando carregar..."
    
    # Para Ubuntu Server, pode precisar instalar kernel modules extras
    sudo apt update
    sudo apt install -y linux-modules-extra-$(uname -r) dkms
    
    # Tentar carregar m√≥dulos
    sudo modprobe binder_linux || echo "‚ùå M√≥dulo binder n√£o dispon√≠vel"
    sudo modprobe ashmem_linux || echo "‚ùå M√≥dulo ashmem n√£o dispon√≠vel"
fi

# 2. CRIAR CONTAINER DISTROBOX ESPEC√çFICO PARA WAYDROID
echo "üì¶ Criando container Distrobox para Waydroid..."

# Usar Arch Linux que tem melhor suporte ao Waydroid
distrobox create \
    --name waydroid-container \
    --image archlinux:latest \
    --additional-flags "--privileged --device /dev/kvm --device /dev/dri" \
    --home ~/waydroid-home

echo "üîß Entrando no container para configurar..."

# 3. SCRIPT PARA EXECUTAR DENTRO DO CONTAINER
cat > ~/setup-waydroid-inside-container.sh << 'EOF'
#!/bin/bash

echo "üèóÔ∏è  Configurando Waydroid dentro do container Arch..."

# Atualizar sistema
sudo pacman -Syu --noconfirm

# Instalar Waydroid
sudo pacman -S --noconfirm waydroid python-pyclip

# Instalar AUR helper (yay)
sudo pacman -S --noconfirm base-devel git
cd /tmp
git clone https://aur.archlinux.org/yay.git
cd yay
makepkg -si --noconfirm
cd ~

# Instalar depend√™ncias adicionais do AUR se necess√°rio
# yay -S --noconfirm waydroid-script-git

# Configurar grupos de usu√°rio
sudo usermod -a -G wheel $USER

# Verificar se podemos acessar dispositivos necess√°rios
echo "üîç Verificando acesso a dispositivos..."
ls -la /dev/kvm /dev/dri/ 2>/dev/null || echo "‚ö†Ô∏è  Alguns dispositivos podem n√£o estar dispon√≠veis"

# Configurar Waydroid
echo "‚öôÔ∏è  Configurando Waydroid..."

# Inicializar Waydroid (pode falhar se m√≥dulos n√£o estiverem dispon√≠veis)
if sudo waydroid init; then
    echo "‚úÖ Waydroid inicializado com sucesso!"
    
    # Configura√ß√µes b√°sicas
    waydroid prop set persist.waydroid.multi_windows true
    waydroid prop set persist.waydroid.cursor_on_subsurface true
    
    echo "üöÄ Para iniciar o Waydroid:"
    echo "  sudo waydroid container start"
    echo "  waydroid session start &"
    echo "  waydroid show-full-ui"
    
else
    echo "‚ùå Falha na inicializa√ß√£o do Waydroid"
    echo "Poss√≠veis problemas:"
    echo "1. M√≥dulos kernel n√£o dispon√≠veis"
    echo "2. Permiss√µes insuficientes"
    echo "3. Kernel n√£o suportado"
fi

EOF

chmod +x ~/setup-waydroid-inside-container.sh

# 4. SCRIPT ALTERNATIVO - WAYDROID NO HOST
cat > ~/setup-waydroid-host.sh << 'EOF'
#!/bin/bash

echo "üè† Alternativa: Instalando Waydroid diretamente no host..."

# Adicionar reposit√≥rio oficial do Waydroid
sudo apt install -y curl ca-certificates
curl https://repo.waydro.id | sudo bash

# Instalar Waydroid
sudo apt update
sudo apt install -y waydroid

# Verificar m√≥dulos do kernel
echo "üîç Verificando m√≥dulos do kernel..."
if sudo modprobe binder_linux && sudo modprobe ashmem_linux; then
    echo "‚úÖ M√≥dulos carregados com sucesso!"
    
    # Inicializar Waydroid
    sudo waydroid init
    
    # Configura√ß√µes
    waydroid prop set persist.waydroid.multi_windows true
    waydroid prop set persist.waydroid.cursor_on_subsurface true
    
    echo "üöÄ Para usar:"
    echo "  sudo waydroid container start"
    echo "  waydroid session start &"
    echo "  waydroid show-full-ui"
    
else
    echo "‚ùå M√≥dulos do kernel n√£o dispon√≠veis"
    echo "Ubuntu Server pode n√£o ter suporte completo"
fi

EOF

chmod +x ~/setup-waydroid-host.sh

# 5. SCRIPT DE USO DI√ÅRIO
cat > ~/.local/bin/waydroid-launcher << 'EOF'
#!/bin/bash

echo "ü§ñ Waydroid Launcher"
echo "===================="
echo "1) Usar Waydroid no host"
echo "2) Usar Waydroid no Distrobox"
echo "3) Verificar status"

read -p "Escolha uma op√ß√£o [1-3]: " choice

case $choice in
    1)
        echo "üè† Iniciando Waydroid no host..."
        sudo waydroid container start
        waydroid session start &
        sleep 3
        waydroid show-full-ui
        ;;
    2)
        echo "üì¶ Entrando no container Waydroid..."
        distrobox enter waydroid-container
        ;;
    3)
        echo "üìä Status do Waydroid:"
        waydroid status 2>/dev/null || echo "Waydroid n√£o est√° rodando"
        echo ""
        echo "üìä Status do container:"
        distrobox list | grep waydroid || echo "Container waydroid n√£o encontrado"
        ;;
    *)
        echo "‚ùå Op√ß√£o inv√°lida"
        ;;
esac

EOF

chmod +x ~/.local/bin/waydroid-launcher

# 6. INSTRU√á√ïES FINAIS
cat << 'EOF'

üéØ PR√ìXIMOS PASSOS:

1Ô∏è‚É£  M√âTODO RECOMENDADO - Host direto:
   ./setup-waydroid-host.sh

2Ô∏è‚É£  M√âTODO ALTERNATIVO - Distrobox:
   distrobox enter waydroid-container
   ./setup-waydroid-inside-container.sh

3Ô∏è‚É£  Para usar diariamente:
   waydroid-launcher

‚ö†Ô∏è  ATEN√á√ÉO:
- Ubuntu Server pode n√£o ter todos os m√≥dulos necess√°rios
- Se m√≥dulos falharem, considere usar um kernel mainline
- Waydroid funciona melhor em distribui√ß√µes com kernel mais recente

üîç VERIFICAR COMPATIBILIDADE:
   lsmod | grep binder
   lsmod | grep ashmem
   uname -r

üì± APPS RECOMENDADOS PARA TESTAR:
- F-Droid (loja alternativa)
- Aurora Store (Google Play sem conta)
- Apps simples como calculadora

EOF

echo "‚úÖ Scripts criados!"
echo "Execute um dos m√©todos acima para continuar."
